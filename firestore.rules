// Firestore rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* Helpers */
    function isSignedIn() { return request.auth != null; }
    function userDoc() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function userRole() { return isSignedIn() ? userDoc().data.role : null; }
    function isSuperAdmin() { return isSignedIn() && userRole() == 'superAdmin'; }
    function isAdmin() { return isSignedIn() && (userRole() == 'admin' || userRole() == 'superAdmin'); }
    // Admin-level teachers (including super-admin teachers) share elevated permissions.
    function isAdminTeacher() { return isSignedIn() && (userRole() == 'adminTeacher' || userRole() == 'superAdminTeacher'); }
    function isSuperAdminTeacher() { return isSignedIn() && userRole() == 'superAdminTeacher'; }
    function isTeacher() { return isSignedIn() && userRole() == 'teacher'; }
    function isTeacherLike() { return isSignedIn() && (userRole() == 'teacher' || userRole() == 'adminTeacher' || userRole() == 'superAdminTeacher'); }
    function isDirector() { return isSignedIn() && userRole() == 'director'; }
    function isAdminOrDirector() { return isSignedIn() && (isAdmin() || isDirector()); }
    function isApproved() { return isSignedIn() && userDoc().data.approved == true; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }
    function absVal(x) { return x >= 0 ? x : -x; }
    function listSize(x) { return x is list ? x.size() : 0; }
    function isAssistantInGroup(g) {
      return g.assistantTeacherIds is list && g.assistantTeacherIds.hasAny([request.auth.uid]);
    }
    function isTeacherAssignedToGroup(groupPath) {
      return isSignedIn() &&
        (
          get(groupPath).data.teacherId == request.auth.uid ||
          isAssistantInGroup(get(groupPath).data)
        );
    }
    function isGroupStudent(groupPath) {
      return exists(groupPath) &&
        exists(concat(groupPath, "/students/", request.auth.uid));
    }
    function isEnrolledInGroup(groupId) {
      return exists(/databases/$(database)/documents/studentEnrollments/$(groupId + "_" + request.auth.uid));
    }
    function isOptionalString(x) {
      return x is string || x == null;
    }
    function canSelfUpsertProfile(userId) {
      return isSelf(userId) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['displayName', 'name', 'photoURL', 'updatedAt', 'mustChangePassword']) &&
        (!("displayName" in request.resource.data) || isOptionalString(request.resource.data.displayName)) &&
        (!("name" in request.resource.data) || isOptionalString(request.resource.data.name)) &&
        (!("photoURL" in request.resource.data) || isOptionalString(request.resource.data.photoURL)) &&
        (!("mustChangePassword" in request.resource.data) || request.resource.data.mustChangePassword is bool);
    }
    // Permite que profesores agreguen su materia a un grupo existente sin modificar otros campos.
    function canTeacherLinkCourseToGroup() {
      return isTeacher() &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['courses', 'courseIds', 'mentorCourseAccess', 'updatedAt']) &&
        request.resource.data.courses is list &&
        request.resource.data.courseIds is list &&
        (!('mentorCourseAccess' in request.resource.data) || request.resource.data.mentorCourseAccess is map) &&
        listSize(request.resource.data.courses) >= listSize(resource.data.courses) &&
        listSize(request.resource.data.courseIds) >= listSize(resource.data.courseIds);
    }
    // Permite a un profesor quitar su curso de un grupo, incluyendo actualizar courseId/courseName cuando corresponde.
    function canTeacherUnlinkCourseFromGroup(groupPath) {
      return isTeacherAssignedToGroup(groupPath) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['courses', 'courseIds', 'mentorCourseAccess', 'updatedAt', 'courseId', 'courseName']) &&
        request.resource.data.courses is list &&
        request.resource.data.courseIds is list &&
        (!('mentorCourseAccess' in request.resource.data) || request.resource.data.mentorCourseAccess is map) &&
        listSize(request.resource.data.courses) <= listSize(resource.data.courses) &&
        listSize(request.resource.data.courseIds) <= listSize(resource.data.courseIds);
    }
    function canTeacherManageMentorsInGroup(groupPath) {
      return isSignedIn() &&
        exists(groupPath) &&
        get(groupPath).data.teacherId == request.auth.uid &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['assistantTeacherIds', 'assistantTeachers', 'mentorCourseAccess', 'updatedAt']) &&
        request.resource.data.assistantTeacherIds is list &&
        request.resource.data.assistantTeachers is list &&
        (!('mentorCourseAccess' in request.resource.data) || request.resource.data.mentorCourseAccess is map);
    }
    function canUpdateLikesCountOnly() {
      return isSignedIn() &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount']) &&
        request.resource.data.likesCount is int &&
        request.resource.data.likesCount >= 0;
    }
    function canUpdateRepliesCountOnly() {
      return isSignedIn() &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['repliesCount']) &&
        request.resource.data.repliesCount is int &&
        request.resource.data.repliesCount >= 0;
    }
    function forumPostIsGraded() {
      // Verificar existencia de campos antes de accederlos para evitar errores
      return ("status" in resource.data && resource.data.status == "graded") ||
        ("grade" in resource.data && resource.data.grade is number) ||
        ("gradedAt" in resource.data && resource.data.gradedAt is timestamp);
    }
    function submissionIsGraded() {
      // Verificar existencia de campos antes de accederlos para evitar errores
      return ("status" in resource.data && resource.data.status == "graded") ||
        ("grade" in resource.data && resource.data.grade is number) ||
        ("gradedAt" in resource.data && resource.data.gradedAt is timestamp);
    }
    function isSubmissionOwner() {
      // Verificar que studentId existe y coincide con el usuario actual
      return "studentId" in resource.data &&
        resource.data.studentId is string &&
        request.auth.uid == resource.data.studentId;
    }
    function studentCourseClosedInGroup(groupId, courseId, studentId) {
      let enrollmentPath = /databases/$(database)/documents/studentEnrollments/$(groupId + "_" + studentId);
      return courseId is string &&
        exists(enrollmentPath) &&
        get(enrollmentPath).data.courseClosures is map &&
        get(enrollmentPath).data.courseClosures.keys().hasAny([courseId]) &&
        get(enrollmentPath).data.courseClosures[courseId] is map &&
        ("status" in get(enrollmentPath).data.courseClosures[courseId]) &&
        get(enrollmentPath).data.courseClosures[courseId].status == "closed";
    }
    function submissionDataIsClosed(groupId, data) {
      return data is map &&
        ("courseId" in data) &&
        data.courseId is string &&
        ("studentId" in data) &&
        data.studentId is string &&
        studentCourseClosedInGroup(groupId, data.courseId, data.studentId);
    }
    function isMentorOfCourse(courseId) {
      // Verifica si el usuario es mentor del curso consultando el array mentorIds
      let courseData = get(/databases/$(database)/documents/courses/$(courseId)).data;
      return isTeacherLike() &&
        exists(/databases/$(database)/documents/courses/$(courseId)) &&
        courseData.keys().hasAny(['mentorIds']) &&
        courseData.mentorIds is list &&
        request.auth.uid in courseData.mentorIds;
    }
    function canManageCourse(courseId) {
      return isAdmin() ||
        isAdminTeacher() ||
        (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/courses/$(courseId)) &&
          get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid
        ) ||
        isMentorOfCourse(courseId);
    }
    
    /* users */
    match /users/{userId} {
      allow read: if isSelf(userId) || isAdmin() || isAdminTeacher();
      allow create: if isAdmin() || isAdminTeacher() || canSelfUpsertProfile(userId);
      allow update: if isAdmin() || isAdminTeacher() || canSelfUpsertProfile(userId);
      allow delete: if isAdmin();

      // Subcolección para progreso visto por alumno
      match /seenClasses/{classId} {
        allow read: if isSelf(userId) || isAdmin() || isAdminTeacher();
        allow write: if isSelf(userId) || isAdmin() || isAdminTeacher();
      }
    }

    /* items */
    match /items/{itemId} {
      allow read: if isApproved() || isAdmin();
      allow create: if isApproved();
      allow update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    /* analyses */
    match /analyses/{analysisId} {
      allow read, write: if isApproved();
    }

    /* alumnos (directorio) */
    match /alumnos/{alumnoId} {
      allow read, create, update, delete: if isSignedIn();
    }

    /* solicitudesCertificado */
    match /solicitudesCertificado/{solicitudId} {
      allow create: if isSignedIn();
      allow read: if isAdminOrDirector() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();

      match /comentarios/{comentarioId} {
        allow read: if isAdminOrDirector() || (
          isSignedIn() &&
          exists(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)) &&
          get(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)).data.userId == request.auth.uid
        );
        allow create: if isAdminOrDirector() || (
          isSignedIn() &&
          exists(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)) &&
          get(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)).data.userId == request.auth.uid
        );
        allow update, delete: if false;
      }
    }

    /* config */
    match /config/{configId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    /* planteles */
    match /planteles/{plantelId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    /* courses y subcolecciones */
    match /courses/{courseId} {
      // Permitir lectura a cualquier usuario autenticado (necesario para alumnos)
      allow read: if isAdmin() || isSignedIn();
      // Permitir creación/edición al propietario aunque falte el rol en users/{uid}
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin() || isAdminTeacher() || (isSignedIn() && resource.data.teacherId == request.auth.uid);

      match /lessons/{lessonId} {
        allow read: if isAdmin() || isSignedIn();
        allow create, update, delete: if canManageCourse(courseId);

        match /classes/{classId} {
          allow read: if isAdmin() || isSignedIn();
          // Para likesCount permitimos a cualquier usuario autenticado actualizar solo ese campo.
          allow update: if canUpdateLikesCountOnly();
          allow create, delete: if canManageCourse(courseId);
          allow update: if canManageCourse(courseId) || canUpdateLikesCountOnly();

          match /questions/{questionId} {
            allow read: if isAdmin() || isSignedIn();
            allow create, update, delete: if canManageCourse(courseId);
          }

          // Likes por usuario
          match /likes/{userId} {
            allow read: if isSignedIn();
            allow create, update, delete: if isSelf(userId) || canManageCourse(courseId) || isAdmin();
          }

          // Comentarios por clase
          match /comments/{commentId} {
            // Lectura abierta para simplificar acceso a hilos en el feed.
            allow read: if true;
            allow create: if isSignedIn();
            allow update, delete: if isAdmin() || canManageCourse(courseId) || (isSignedIn() && resource.data.authorId == request.auth.uid);
          }

          // Foro (posts por clase, opcional)
          match /forums/{postId} {
            allow read: if isSignedIn();
            // Crear: alumno autenticado que se firma como autor, o profesor/admin del curso.
            allow create: if (isSignedIn() && request.resource.data.authorId == request.auth.uid) || isAdmin() || canManageCourse(courseId);
            // Update: profesor/admin del curso, el autor del post, o cualquiera que solo actualice repliesCount.
            allow update: if isAdmin() ||
              canManageCourse(courseId) ||
              (isSignedIn() && resource.data.authorId == request.auth.uid && !forumPostIsGraded()) ||
              canUpdateRepliesCountOnly();
            // Delete: profesor/admin del curso o el autor del post.
            allow delete: if isAdmin() ||
              canManageCourse(courseId) ||
              (isSignedIn() && resource.data.authorId == request.auth.uid && !forumPostIsGraded());

            // Respuestas a las aportaciones del foro (hilos públicos)
            match /replies/{replyId} {
              allow read: if isSignedIn();
              // Crear: cualquier usuario autenticado que se firma como autor
              allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
              // Update/Delete: profesor/admin del curso o el autor de la respuesta
              allow update, delete: if isAdmin() || canManageCourse(courseId) || (isSignedIn() && resource.data.authorId == request.auth.uid);
            }
          }

          // Respuestas/entregas de quizzes o clases
          match /responses/{responseId} {
            allow read: if isAdmin() || isSignedIn();
            allow delete: if canManageCourse(courseId) || isAdmin();
          }
        }
      }

      // Inscripciones por curso (subcolección anidada en el curso)
      match /enrollments/{userId} {
        allow read: if isAdmin() || isSignedIn();
        allow create, update, delete: if canManageCourse(courseId);
      }
    }

    /* programs (catálogo de carreras) */
    match /programs/{programId} {
      allow read: if isSignedIn();
      // Permitir creación/edición a profesores y administradores; como fallback, cualquier usuario autenticado
      // puede crear/editar programas para evitar bloquear si el rol aún no está poblado.
      allow create: if isTeacherLike() || isAdmin() || isSignedIn();
      allow update, delete: if isTeacherLike() || isAdmin() || isSignedIn();
    }

    /* groups */
    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow create: if isAdmin() || isAdminTeacher();
      allow update: if isAdmin() || isAdminTeacher() ||
        canTeacherManageMentorsInGroup(/databases/$(database)/documents/groups/$(groupId)) ||
        canTeacherLinkCourseToGroup() ||
        canTeacherUnlinkCourseFromGroup(/databases/$(database)/documents/groups/$(groupId));
      allow delete: if isAdmin() || isAdminTeacher();

      match /students/{studentId} {
        allow read: if isAdmin() || isAdminTeacher() ||
          (isSignedIn() &&
            (
              isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId)) ||
              studentId == request.auth.uid
            )
          );
        allow create, update, delete: if isAdmin() || isAdminTeacher() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
      }

      match /submissions/{submissionId} {
        allow read: if isAdmin() || isAdminTeacher() || (
          isSignedIn() &&
          exists(/databases/$(database)/documents/groups/$(groupId))
        );
        // Permitir crear submission si el usuario está autenticado y es el estudiante del submission
        // Ya no verificamos isGroupStudent o isEnrolledInGroup porque con múltiples grupos esto falla
        allow create: if isAdmin() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          (
            isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId)) ||
            request.resource.data.studentId == request.auth.uid
          )
        ) || (
          isSignedIn() &&
          request.resource.data.studentId == request.auth.uid &&
          !submissionDataIsClosed(groupId, request.resource.data)
        );
        // Estudiante puede actualizar su propia entrega si NO está calificada
        // y la materia no está cerrada (estado actual y estado destino).
        allow update: if (
          request.auth != null &&
          "studentId" in resource.data &&
          resource.data.studentId == request.auth.uid &&
          !submissionIsGraded() &&
          !submissionDataIsClosed(groupId, resource.data) &&
          !submissionDataIsClosed(groupId, request.resource.data)
        ) || isAdmin() || isAdminTeacher() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
        // Estudiante puede eliminar su propia entrega si NO está calificada
        // y la materia no está cerrada.
        allow delete: if (
          request.auth != null &&
          "studentId" in resource.data &&
          resource.data.studentId == request.auth.uid &&
          !submissionIsGraded() &&
          !submissionDataIsClosed(groupId, resource.data)
        ) || isAdmin() || isAdminTeacher() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
      }

      match /grades/{studentId} {
        allow read, create, update, delete: if isAdmin() || isAdminTeacher() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
      }
    }

    /* studentEnrollments */
    match /studentEnrollments/{enrollmentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || isSignedIn();

      // Progreso por clase (para alumnos y admins)
      // Simplificado para evitar errores cuando userDoc() no existe
      match /classProgress/{classId} {
        allow read, write: if isSignedIn();
      }
    }

    // Regla para collectionGroup queries en forums (necesaria para consultas globales)
    match /{path=**}/forums/{postId} {
      allow read: if isSignedIn();
    }

    // Permitir collectionGroup queries de submissions para admins/docentes admin
    match /{path=**}/submissions/{submissionId} {
      allow read: if isAdmin() || isAdminTeacher();
    }

    // Permitir collectionGroup queries de students para admins/docentes admin
    match /{path=**}/students/{studentId} {
      allow read: if isAdmin() || isAdminTeacher();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
