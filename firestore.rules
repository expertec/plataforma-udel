// Firestore rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* Helpers */
    function isSignedIn() { return request.auth != null; }
    function userDoc() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function userRole() { return isSignedIn() ? userDoc().data.role : null; }
    function isSuperAdmin() { return isSignedIn() && userRole() == 'superAdmin'; }
    function isAdmin() { return isSignedIn() && (userRole() == 'admin' || userRole() == 'superAdmin'); }
    function isAdminTeacher() { return isSignedIn() && userRole() == 'adminTeacher'; }
    function isTeacher() { return isSignedIn() && userRole() == 'teacher'; }
    function isTeacherLike() { return isSignedIn() && (userRole() == 'teacher' || userRole() == 'adminTeacher'); }
    function isDirector() { return isSignedIn() && userRole() == 'director'; }
    function isAdminOrDirector() { return isSignedIn() && (isAdmin() || isDirector()); }
    function isApproved() { return isSignedIn() && userDoc().data.approved == true; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }
    function absVal(x) { return x >= 0 ? x : -x; }
    function listSize(x) { return x is list ? x.size() : 0; }
    function isAssistantInGroup(g) {
      return g.assistantTeacherIds is list && g.assistantTeacherIds.hasAny([request.auth.uid]);
    }
    function isTeacherAssignedToGroup(groupPath) {
      return isSignedIn() &&
        (
          get(groupPath).data.teacherId == request.auth.uid ||
          isAssistantInGroup(get(groupPath).data)
        );
    }
    function isGroupStudent(groupPath) {
      return exists(groupPath) &&
        exists(concat(groupPath, "/students/", request.auth.uid));
    }
    function isEnrolledInGroup(groupId) {
      return exists(/databases/$(database)/documents/studentEnrollments/$(groupId + "_" + request.auth.uid));
    }
    // Permite que profesores agreguen su materia a un grupo existente sin modificar otros campos.
    function canTeacherLinkCourseToGroup() {
      return isTeacher() &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['courses', 'courseIds', 'updatedAt']) &&
        request.resource.data.courses is list &&
        request.resource.data.courseIds is list &&
        listSize(request.resource.data.courses) >= listSize(resource.data.courses) &&
        listSize(request.resource.data.courseIds) >= listSize(resource.data.courseIds);
    }
    function canUpdateLikesCountOnly() {
      return isSignedIn() &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount']) &&
        request.resource.data.likesCount is int &&
        request.resource.data.likesCount >= 0;
    }
    
    /* users */
    match /users/{userId} {
      allow read: if isSelf(userId) || isAdmin() || isAdminTeacher() || (isSignedIn() && resource.data.role == 'student');
      allow create: if isAdmin() || isAdminTeacher();
      allow update: if isAdmin() || isAdminTeacher();
      allow delete: if isAdmin();

      // Subcolecci√≥n para progreso visto por alumno
      match /seenClasses/{classId} {
        allow read: if isSelf(userId) || isAdmin() || isAdminTeacher();
        allow write: if isSelf(userId) || isAdmin() || isAdminTeacher();
      }
    }

    /* items */
    match /items/{itemId} {
      allow read: if isApproved() || isAdmin();
      allow create: if isApproved();
      allow update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    /* analyses */
    match /analyses/{analysisId} {
      allow read, write: if isApproved();
    }

    /* alumnos (directorio) */
    match /alumnos/{alumnoId} {
      allow read, create, update, delete: if isSignedIn();
    }

    /* solicitudesCertificado */
    match /solicitudesCertificado/{solicitudId} {
      allow create: if isSignedIn();
      allow read: if isAdminOrDirector() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();

      match /comentarios/{comentarioId} {
        allow read: if isAdminOrDirector() || (
          isSignedIn() &&
          exists(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)) &&
          get(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)).data.userId == request.auth.uid
        );
        allow create: if isAdminOrDirector() || (
          isSignedIn() &&
          exists(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)) &&
          get(/databases/$(database)/documents/solicitudesCertificado/$(solicitudId)).data.userId == request.auth.uid
        );
        allow update, delete: if false;
      }
    }

    /* config */
    match /config/{configId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    /* planteles */
    match /planteles/{plantelId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    /* courses y subcolecciones */
    match /courses/{courseId} {
      // Permitir lectura a cualquier usuario autenticado (necesario para alumnos)
      allow read: if isAdmin() || isSignedIn();
      allow create: if isTeacherLike() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin() || (isTeacherLike() && resource.data.teacherId == request.auth.uid);

      match /lessons/{lessonId} {
        allow read: if isAdmin() || isSignedIn();
        allow create, update, delete: if isAdmin() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/courses/$(courseId)) &&
          get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid
        );

        match /classes/{classId} {
          allow read: if isAdmin() || isSignedIn();
          // Para likesCount permitimos a cualquier usuario autenticado actualizar solo ese campo.
          allow update: if canUpdateLikesCountOnly();
          allow create, delete: if isAdmin() || (
            isTeacherLike() &&
            exists(/databases/$(database)/documents/courses/$(courseId)) &&
            get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid
          );
          allow update: if isAdmin() || (
            isTeacherLike() &&
            exists(/databases/$(database)/documents/courses/$(courseId)) &&
            get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid
          ) || canUpdateLikesCountOnly();

          match /questions/{questionId} {
            allow read: if isAdmin() || isSignedIn();
            allow create, update, delete: if isAdmin() || (
              isTeacherLike() &&
              exists(/databases/$(database)/documents/courses/$(courseId)) &&
              get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid
            );
          }

          // Likes por usuario
          match /likes/{userId} {
            allow read: if isSignedIn();
            allow create, update, delete: if isSelf(userId) || isAdmin();
          }

          // Comentarios por clase
          match /comments/{commentId} {
            // Lectura abierta para simplificar acceso a hilos en el feed.
            allow read: if true;
            allow create: if isSignedIn();
            allow update, delete: if isAdmin() || (isSignedIn() && resource.data.authorId == request.auth.uid);
          }
        }
      }
    }

    /* groups */
    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow create: if isAdmin() || isAdminTeacher();
      allow update: if isAdmin() || isAdminTeacher() || canTeacherLinkCourseToGroup();
      allow delete: if isAdmin() || isAdminTeacher();

      match /students/{studentId} {
        allow read: if isAdmin() ||
          (isSignedIn() &&
            (
              isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId)) ||
              studentId == request.auth.uid
            )
          );
        allow create, update, delete: if isAdmin() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
      }

      match /submissions/{submissionId} {
        allow read: if isAdmin() || (
          isSignedIn() &&
          exists(/databases/$(database)/documents/groups/$(groupId))
        );
        allow create: if isAdmin() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          (
            isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId)) ||
            request.resource.data.studentId == request.auth.uid
          )
        ) || (
          isSignedIn() &&
          request.resource.data.studentId == request.auth.uid &&
          (
            isGroupStudent(/databases/$(database)/documents/groups/$(groupId)) ||
            isEnrolledInGroup(groupId)
          )
        );
        allow update, delete: if isAdmin() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
      }

      match /grades/{studentId} {
        allow read, create, update, delete: if isAdmin() || (
          isTeacherLike() &&
          exists(/databases/$(database)/documents/groups/$(groupId)) &&
          isTeacherAssignedToGroup(/databases/$(database)/documents/groups/$(groupId))
        );
      }
    }

    /* studentEnrollments */
    match /studentEnrollments/{enrollmentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || isSignedIn();

      // Progreso por clase (para alumnos y admins)
      match /classProgress/{classId} {
        allow read, write: if isSignedIn() && (
          get(/databases/$(database)/documents/studentEnrollments/$(enrollmentId)).data.studentId == request.auth.uid
          || isAdmin()
        );
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
